<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Picto Planner</title>

    <meta name="description"
        content="TC_tam Picto Planner: Een gebruiksvriendelijke tool voor autisten met simpele pictogrammen. Plan en beheer speciale activiteiten, verzorging, buiten- en binnenactiviteiten en vervoer. Upload en verwijder pictogrammen eenvoudig.">
    <meta name="keywords"
        content="Picto Planner, autisten, pictogrammen, planning, activiteiten, gehandicapten, uploaden, picto, pictos, TC_tam">
    <meta name="author" content="Tamer Çevik">

    <link rel="stylesheet" href="/style.css">
    <script src="/script.js"></script>

    <style>
        #planner-container {
            display: none;
        }

        .setup-menu {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            width: 80%;
            height: 80%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, var(--bg-accent-color2), var(--bg-accent-color1));
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 5;
            border-radius: var(--border-radius2);
            overflow-y: auto;
        }

        .settings-menu {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            width: 80%;
            height: 80%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, var(--bg-accent-color2), var(--bg-accent-color1));
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 5;
            border-radius: var(--border-radius2);
            text-align: left;
            align-content: left;
            justify-content: left;
            overflow-y: auto;
        }

        .setup-menu button {
            flex: 1;
            height: 100%;
        }

        #setupButtons {
            display: flex;
        }

        .no-arrows::-webkit-inner-spin-button,
        .no-arrows::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #planner-content {
            border-radius: var(--border-radius2);
            padding: 15px;
            margin: 25px;
        }

        .picto {
            width: 125px;
            height: 125px;
            border: 1px var(--text-color) solid;
            padding: 5px;
            margin-left: 5px;
            margin-right: 5px;
            user-select: none;
        }

        .settings-menu input {
            margin-left: 0px;
            margin-top: 5px;
            margin-right: 5px;
        }

        #done-editing-button {
            display: none;
        }

        @media (orientation: portrait) {
            .setup-menu {
                width: 85%;
                height: 93%;
                display: none;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }

            .setup-menu button {
                display: block;
                margin: 10px 0;
                width: 100%;
            }

            .settings-menu {
                width: 85%;
                height: 93%;
                display: none;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }

            #setupButtons {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
        }

        @media (max-width: 1299px) {
            #edit-pictos {
                background: linear-gradient(135deg, var(--bg-accent-color2), var(--bg-accent-color1));
                display: none;
                box-shadow: 0px 0px 10px var(--h1234-color);
                border-radius: var(--border-radius3);
                padding-top: 10px;
                padding-left: 20px;
                padding-right: 20px;
            }

            #planner-container.visible {
                display: block;
            }
        }

        @media (min-width: 1300px) {
            #edit-pictos {
                background: linear-gradient(135deg, var(--bg-accent-color2), var(--bg-accent-color1));
                display: none;
                align-content: left;
                text-align: left;
                justify-content: left;
                position: fixed;
                right: 20px;
                top: 20px;
                bottom: 20px;
                border-left: 0px var(--h1234-color) solid;
                border-radius: var(--border-radius3);
                padding: 25px;
                background-color: var(--bg-accent-color2);
                min-width: 620px;
                max-width: 620px;
                width: auto;
                overflow-y: scroll;
                box-shadow: 0px 0px 10px var(--h1234-color);
            }

            #planner-container.visible {
                display: flex;
            }

            #edit-pictos .picto {
                width: 100px;
                height: 100px;
            }

            #left-side {
                width: 100%;
            }

            #left-side.editing {
                width: calc(100% - 670px);
            }
        }

        #edit-pictos::-webkit-scrollbar {
            display: none;
        }

        #edit-pictos .picto {
            cursor: pointer;
            transition: transform 0.1s;
        }

        #edit-pictos .picto:active {
            transform: scale(1.1);
        }

        .perm-picto {
            margin: 3px;
        }
    </style>
</head>

<body>
    <div id="setup-menu" class="setup-menu">
        <h2>Laten we de planner instellen.</h2>
        <div id="pinOrNot">
            <h4>Wil je een pincode instellen?</h4>
            <p style="margin: 5px;">Een pincode zorgt ervoor dat je kind de planning niet zomaar kan veranderen.</p>
            <div id="setupButtons">
                <button onclick="setupCreatePin()">Ja, stel een code in!</button>
                <button onclick="setupCompleted()">Nee, ga verder zonder code!</button>
            </div>
        </div>

        <div id="pinSetup" style="display:none;">
            <h4>Voer een pincode in:</h4>
            <input autocomplete="off" type="text" id="pincode" placeholder="Pincode" maxlength="6"
                oninput="this.value = this.value.replace(/[^0-9]/g, '');" class="no-arrows">
            <button onclick="pincode('set', 'setup', document.getElementById('pincode').value)">Pincode
                instellen</button>
        </div>
    </div>

    <div id="settings-menu" class="settings-menu">
        <button onclick="toggleSettings()">Sluiten</button>

        <h4>Pincode:</h4>
        <input autocomplete="off" type="text" id="pincodeS" placeholder="Pincode (laat leeg om uit te schakelen)"
            maxlength="6" oninput="this.value = this.value.replace(/[^0-9]/g, '');" class="no-arrows"
            style="width: 300px; max-width: 100%;">
        <button onclick="pincode('set', 'settings', document.getElementById('pincodeS').value)">Pincode
            instellen</button>

        <br><button onclick="clearDatabase()" style="border: none; background-color: red;">Reset de hele picto
            planner</button>
    </div>

    <div id="planner-container">
        <div id="left-side">
            <h1 id="title" style="margin-bottom: -10px; margin-top: 60px;">TC_tam Picto Planner</h1>
            <h4 style="font-size: 1em;">Pictogrammen geleverd door sclera.be</h4>

            <div id="planner-content"></div>
        </div>

        <div id="edit-pictos">
            <div style="display: flex;">
                <button onclick="removePlanning()" style="flex: 1; border: none; background-color: red;">Verwijder de
                    planning</button>
                <button onclick="removeUploaded()" style="flex: 1; border: none; background-color: red;">Verwijder
                    geüploade picto's</button>
                <button onclick="savePictosAsPreset()" style="flex: 1;">Sla planning op</button>
            </div>
            <br>

            <h3 style="margin-top: -5px;">Opgeslagen planningen:</h3>
            <div style="margin-bottom: 10px;" id="preset-selecter"></div>

            <input style="margin-left: 0px; margin-top: 0px !important; margin-bottom: 5px !important;" type="text"
                id="search-bar" autocomplete="off" placeholder="Zoek pictogrammen...">

            <div class="all-pictos">
                <h3>Dagen van de week:</h3>
                <img class="picto perm-picto" src="/picto-planner/dagen/maandag.png" title="Maandag">
                <img class="picto perm-picto" src="/picto-planner/dagen/dinsdag.png" title="Dinsdag">
                <img class="picto perm-picto" src="/picto-planner/dagen/woensdag.png" title="Woensdag">
                <img class="picto perm-picto" src="/picto-planner/dagen/donderdag.png" title="Donderdag">
                <img class="picto perm-picto" src="/picto-planner/dagen/vrijdag.png" title="Vrijdag">
                <img class="picto perm-picto" src="/picto-planner/dagen/zaterdag.png" title="Zaterdag">
                <img class="picto perm-picto" src="/picto-planner/dagen/zondag.png" title="Zondag">

                <h3>Speciale activiteiten:</h3>
                <img class="picto perm-picto" src="/picto-planner/speciale-activiteiten/verjaardag.png"
                    title="Koningsdag">
                <img class="picto perm-picto" src="/picto-planner/speciale-activiteiten/pasen.png" title="Pasen">
                <img class="picto perm-picto" src="/picto-planner/speciale-activiteiten/samen-vieren.png"
                    title="Verjaardag">
                <img class="picto perm-picto" src="/picto-planner/speciale-activiteiten/vuurwerk.png"
                    title="Oud en nieuw">
                <img class="picto perm-picto" src="/picto-planner/speciale-activiteiten/geschenk.png" title="Cadeautje">
                <img class="picto perm-picto" src="/picto-planner/speciale-activiteiten/sinterklaas.png"
                    title="Sinterklaas">
                <img class="picto perm-picto" src="/picto-planner/speciale-activiteiten/schoen-zetten.png"
                    title="Schoen zetten">
                <img class="picto perm-picto" src="/picto-planner/speciale-activiteiten/kerstmis.png" title="Kerst">
                <img class="picto perm-picto" src="/picto-planner/speciale-activiteiten/bungalow.png"
                    title="Vakantiehuisje">
                <img class="picto perm-picto" src="/picto-planner/speciale-activiteiten/halloween.png"
                    title="Halloween">

                <h3>Verzorging:</h3>
                <img class="picto perm-picto" src="/picto-planner/verzorging/nagel-knippen.png" title="Nagels knippen">
                <img class="picto perm-picto" src="/picto-planner/verzorging/kapper.png" title="Haren knippen">
                <img class="picto perm-picto" src="/picto-planner/verzorging/tanden-poetsen.png" title="Tanden poetsen">
                <img class="picto perm-picto" src="/picto-planner/verzorging/gel-haar.png" title="Haren doen">
                <img class="picto perm-picto" src="/picto-planner/verzorging/handen-wassen.png" title="Handen wassen">
                <img class="picto perm-picto" src="/picto-planner/verzorging/spuit.png" title="Prik">
                <img class="picto perm-picto" src="/picto-planner/verzorging/voeten-wassen.png" title="Voeten wassen">

                <h3>Buitenactiviteiten:</h3>
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/park.png"
                    title="Naar het park">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/winkelen.png"
                    title="Naar de winkel">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/ziekenhuis.png"
                    title="Naar het ziekenhuis">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/apotheek.png"
                    title="Naar de apotheek">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/markt.png"
                    title="Naar de markt">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/museum.png"
                    title="Naar het museum">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/bakker.png"
                    title="Naar de bakker">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/vliegveld.png"
                    title="Naar het vliegveld">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/restaurant.png"
                    title="Naar het restaurant">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/fitness-center.png"
                    title="Naar de sportschool">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/boerderij.png"
                    title="Naar de boederij">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/speeltuin.png"
                    title="Naar de speeltuin">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/wasstraat.png"
                    title="Naar de wasstraat">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/brievenbus.png"
                    title="Post versturen">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/huis.png" title="Naar huis">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/strand.png"
                    title="Naar het strand">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/kermis.png"
                    title="Naar de kermis">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/zwemmen.png"
                    title="Naar het zwembad">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/picnic.png"
                    title="Picknicken">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/school.png"
                    title="Naar school">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/wandelen.png"
                    title="Wandelen">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/kledingwinkel.png"
                    title="Naar de kledingwinkel">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/cinema.png"
                    title="Naar de bioscoop">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-buitenhuis/buitenspelen.jpg"
                    title="Buitenspelen">

                <h3>Binnenactiviteiten:</h3>
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/computer-alleen.png"
                    title="Alleen gamen">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/computer-samen.png"
                    title="Samen gamen">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/spelen-alleen.png"
                    title="Alleen spelen">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/spelen-samen.png"
                    title="Samen spelen">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/fruit.png" title="Fruit eten">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/ontbijt.png" title="Ontbijt">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/middagmaal.png" title="Lunch">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/avondmaal.png"
                    title="Avondeten">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/opstaan.png" title="Opstaan">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/slapen.jpg" title="Slapen">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/tablet.png"
                    title="Spelen op de tablet ">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/pictogrammen.png"
                    title="Picto's klaarmaken">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/koken.png" title="Koken">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/bureauwerk.png"
                    title="Studeren">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/tv.png" title="TV kijken">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/tekenen.png" title="Tekenen">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/tussendoortje.png"
                    title="Tussendoortje">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/bad.png" title="Douchen">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/zwijgen.png"
                    title="Stil zijn">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/huiswerk-stil.png"
                    title="Stil werken">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/timetimer.png"
                    title="Time timer">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/opruimen.png"
                    title="Opruimen">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/schoonmaken.png"
                    title="Schoonmaken">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/barbeque.png"
                    title="Barbecueën">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/boek.png"
                    title="Boekje lezen">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/rugzak-inpakken.png"
                    title="Tas inpakken">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/klok.png" title="Klok">
                <img class="picto perm-picto" src="/picto-planner/activiteiten-binnenhuis/gym.png" title="Gymmen">

                <h3>Vervoer:</h3>
                <img class="picto perm-picto" src="/picto-planner/vervoer/taxi.png" title="Taxi">
                <img class="picto perm-picto" src="/picto-planner/vervoer/auto.png" title="Auto">
                <img class="picto perm-picto" src="/picto-planner/vervoer/tandem.png" title="Tandem">
                <img class="picto perm-picto" src="/picto-planner/vervoer/treinstation.png" title="Station">
                <img class="picto perm-picto" src="/picto-planner/vervoer/trein.png" title="Trein">
                <img class="picto perm-picto" src="/picto-planner/vervoer/metro.png" title="Metro">
                <img class="picto perm-picto" src="/picto-planner/vervoer/tram.png" title="Tram">
                <img class="picto perm-picto" src="/picto-planner/vervoer/vliegtuig.png" title="Vliegtuig">
                <img class="picto perm-picto" src="/picto-planner/vervoer/motor.png" title="Motor">
                <img class="picto perm-picto" src="/picto-planner/vervoer/boot.png" title="Boot">
                <img class="picto perm-picto" src="/picto-planner/vervoer/ov.png" title="Openbaar vervoer">
                <img class="picto perm-picto" src="/picto-planner/vervoer/ov-chipkaart.png" title="OV-chipkaart">

                <h3>Geüploade picto's</h3>
                <button style="margin-bottom: -10px;" id="upload-picto-button">Upload een picto</button>
                <p>Waarschuwing: te veel geüploade picto's kunnen de prestaties van je apparaat beïnvloeden.</p>

                <div id="uploaded-pictos"></div>
            </div>

            <input type="file" id="upload-picto-input" accept="image/*" multiple style="display: none;" />
        </div>

        <button id="settings-button" style="position: fixed; top: 5px; left: 5px;"
            onclick="toggleSettings()">Instellingen</button>

        <button id="edit-button" style="position: fixed; top: 5px; right: 5px;" onclick="editPlanner()">Planner
            aanpassen</button>
        <button id="done-editing-button" style="position: fixed; top: 5px; right: 5px;"
            onclick="doneEditingPlanner()">Klaar</button>
    </div>

    <script>
        const plannerContent = document.getElementById('planner-content');
        const pictos = document.querySelectorAll('#edit-pictos .picto');

        const dbName = 'PictoPlannerDB';
        const pictosDB = 'pictos';
        const uploadedPictosDB = 'uploadedPictos';
        const pictoPresetsDB = 'pictoPresets';
        const settingsDB = 'settings';
        let db;

        const openDatabase = () => {
            const request = indexedDB.open(dbName, 2);

            request.onupgradeneeded = (event) => {
                db = event.target.result;

                if (!db.objectStoreNames.contains(pictosDB)) {
                    db.createObjectStore(pictosDB, { keyPath: 'id' });
                }

                if (!db.objectStoreNames.contains(uploadedPictosDB)) {
                    db.createObjectStore(uploadedPictosDB, { keyPath: 'id' });
                }

                if (!db.objectStoreNames.contains(pictoPresetsDB)) {
                    db.createObjectStore(pictoPresetsDB, { keyPath: 'id' });
                }

                if (!db.objectStoreNames.contains(settingsDB)) {
                    db.createObjectStore(settingsDB, { keyPath: 'id' });
                }

                console.log("Database geüpgraded en stores gecontroleerd/aangemaakt");
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                console.log("Database geopend:", dbName);
                loadPictos();
                loadUploadedPictos();
                checkSettings();
                loadFirstPictosInPresetSelecter();
            };

            request.onerror = (event) => {
                console.error('Database fout:', event.target.error);
            };
        };

        const clearDatabase = () => {
            if (confirm("Weet je zeker dat je de volledige picto planner wilt resetten? Dit kan niet ongedaan gemaakt worden.")) {
                const transaction = db.transaction([pictosDB, uploadedPictosDB, settingsDB], 'readwrite');

                transaction.objectStore(pictosDB).clear();
                transaction.objectStore(uploadedPictosDB).clear();
                transaction.objectStore(settingsDB).clear();

                transaction.oncomplete = () => {
                    console.log("De picto planner is gereset.");
                    location.reload();
                };

                transaction.onerror = (event) => {
                    notification('Fout bij het legen van de database:', event.target.error);
                };
            }
        };

        const removePlanning = () => {
            if (confirm('Weet je zeker dat je alle picto\'s uit de planning wilt verwijderen?')) {
                const transaction = db.transaction(pictosDB, 'readwrite');
                const objectStore = transaction.objectStore(pictosDB);

                const request = objectStore.getAll();
                request.onsuccess = (event) => {
                    const pictos = event.target.result;
                    pictos.forEach(picto => {
                        objectStore.delete(picto.id);
                        const pictoElement = plannerContent.querySelector(`img[data-id='${picto.id}']`);
                        if (pictoElement) {
                            plannerContent.removeChild(pictoElement);
                        }
                    });
                    notification('Alle picto\'s uit de planning zijn verwijderd.');
                };

                request.onerror = (event) => {
                    notification('Fout bij ophalen pictos voor verwijderen:' + event.target.error);
                };
            }
        };

        const removeUploaded = () => {
            if (confirm('Weet je zeker dat je alle geüploade picto\'s wilt verwijderen?')) {
                const transaction = db.transaction(uploadedPictosDB, 'readwrite');
                const objectStore = transaction.objectStore(uploadedPictosDB);

                const request = objectStore.getAll();
                request.onsuccess = (event) => {
                    const pictos = event.target.result;
                    pictos.forEach(picto => {
                        objectStore.delete(picto.id);
                        const pictoElement = document.querySelector(`#uploaded-pictos img[data-id='${picto.id}']`);
                        if (pictoElement) {
                            const pictoContainer = pictoElement.parentElement;
                            document.getElementById('uploaded-pictos').removeChild(pictoContainer);
                        }
                    });
                    notification('Alle geüploade picto\'s zijn verwijderd.');
                };

                request.onerror = (event) => {
                    notification('Fout bij ophalen geüploade pictos voor verwijderen:' + event.target.error);
                };
            }
        };

        const savePicto = (pictoSrc, pictoTitle, store) => {
            const transaction = db.transaction([store], 'readwrite');
            const objectStore = transaction.objectStore(store);

            const picto = { id: Date.now(), src: pictoSrc, title: pictoTitle };
            const request = objectStore.add(picto);

            request.onsuccess = () => {
                console.log('Picto opgeslagen:', picto);
                if (store === uploadedPictosDB) {
                    addUploadedPictoToEditSection(pictoSrc, pictoTitle, picto.id);
                } else if (store === pictosDB) {
                    addPictoToPlanner(pictoSrc, pictoTitle, picto.id);
                }
            };

            request.onerror = (event) => {
                console.error('Fout bij opslaan:', event.target.error);
            };
        };

        const loadPictos = () => {
            const transaction = db.transaction([pictosDB], 'readonly');
            const objectStore = transaction.objectStore(pictosDB);
            const request = objectStore.getAll();

            request.onsuccess = (event) => {
                const pictos = event.target.result;
                pictos.forEach(picto => {
                    addPictoToPlanner(picto.src, picto.title, picto.id);
                });
            };

            request.onerror = (event) => {
                console.error('Fout bij ophalen:', event.target.error);
            };
        };

        const loadUploadedPictos = () => {
            const transaction = db.transaction([uploadedPictosDB], 'readonly');
            const objectStore = transaction.objectStore(uploadedPictosDB);
            const request = objectStore.getAll();

            request.onsuccess = (event) => {
                const pictos = event.target.result;
                pictos.forEach(picto => {
                    addUploadedPictoToEditSection(picto.src, picto.title, picto.id);
                });
            };

            request.onerror = (event) => {
                console.error('Fout bij ophalen geüploade pictos:', event.target.error);
            };
        };

        const addPictoToPlanner = (src, title, id) => {
            const newPicto = document.createElement('img');
            newPicto.src = src;
            newPicto.className = 'picto';
            newPicto.title = title;
            newPicto.setAttribute('data-id', id);

            newPicto.addEventListener('click', () => {
                const editButton = document.getElementById('edit-button');
                if (editButton.style.display === 'none') {
                    removePictoFromPlanner(id, newPicto);
                }
            });

            plannerContent.appendChild(newPicto);
        };

        const addUploadedPictoToEditSection = (src, title, id) => {
            const pictoContainer = document.createElement('div');
            pictoContainer.style.position = 'relative';
            pictoContainer.style.display = 'inline-block';

            const newPicto = document.createElement('img');
            newPicto.src = src;
            newPicto.className = 'uploaded-picto picto';
            newPicto.title = title;
            newPicto.setAttribute('data-id', id);

            const removeButton = document.createElement('img');
            removeButton.src = '/assets/close-button.png';
            removeButton.className = 'remove-picto-button';
            removeButton.style.position = 'absolute';
            removeButton.style.top = '3px';
            removeButton.style.right = '7px';
            removeButton.style.color = 'black';
            removeButton.style.backgroundColor = 'red';
            removeButton.style.border = '1px var(--text-color) solid';
            removeButton.style.cursor = 'pointer';
            removeButton.style.borderRadius = '50%';
            removeButton.style.width = '30px';
            removeButton.style.height = '30px';
            removeButton.style.display = 'flex';
            removeButton.style.alignItems = 'center';
            removeButton.style.justifyContent = 'center';
            removeButton.style.zIndex = '1';

            removeButton.addEventListener('click', (event) => {
                event.stopPropagation();
                removeUploadedPicto(id, pictoContainer);
            });

            newPicto.addEventListener('click', () => {
                savePicto(src, title, pictosDB);
            });

            pictoContainer.appendChild(newPicto);
            pictoContainer.appendChild(removeButton);
            document.getElementById('uploaded-pictos').appendChild(pictoContainer);
        };

        const removeUploadedPicto = (id, pictoElement) => {
            const transaction = db.transaction([uploadedPictosDB], 'readwrite');
            const objectStore = transaction.objectStore(uploadedPictosDB);

            const request = objectStore.delete(id);

            request.onsuccess = () => {
                console.log('Uploaded Picto verwijderd uit database:', id);
                document.getElementById('uploaded-pictos').removeChild(pictoElement);
            };

            request.onerror = (event) => {
                console.error('Fout bij verwijderen van de uploaded picto:', event.target.error);
            };
        };

        const removePictoFromPlanner = (id, pictoElement) => {
            const transaction = db.transaction([pictosDB], 'readwrite');
            const objectStore = transaction.objectStore(pictosDB);

            const request = objectStore.delete(id);

            request.onsuccess = () => {
                console.log('Picto verwijderd uit database:', id);
                plannerContent.removeChild(pictoElement);
            };

            request.onerror = (event) => {
                console.error('Fout bij verwijderen:', event.target.error);
            };
        };

        document.getElementById('upload-picto-button').addEventListener('click', () => {
            document.getElementById('upload-picto-input').click();
        });

        document.getElementById('upload-picto-input').addEventListener('change', (event) => {
            const files = event.target.files;
            if (files.length > 0) {
                const fileArray = Array.from(files);
                processFileQueue(fileArray, files.length);
            }
        });

        function processFileQueue(fileArray, totalFiles) {
            if (fileArray.length === 0) {
                return;
            }

            const file = fileArray.shift();
            const reader = new FileReader();
            const uploadedFiles = totalFiles - fileArray.length;

            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    canvas.width = 300;
                    canvas.height = 300;

                    ctx.drawImage(img, 0, 0, 300, 300);

                    const pictoSrc = canvas.toDataURL('image/jpeg');
                    const pictoTitle = file.name;

                    savePicto(pictoSrc, pictoTitle, uploadedPictosDB);

                    const progressPercentage = Math.round((uploadedFiles / totalFiles) * 100);
                    notification(`Upload progress: ${progressPercentage}%`);

                    adjustTimeout(() => {
                        processFileQueue(fileArray, totalFiles);
                    });
                };
                img.src = e.target.result;
            };

            reader.readAsDataURL(file);
        }

        function adjustTimeout(callback) {
            const memory = performance.memory;
            const usedJSHeapSize = memory.usedJSHeapSize / memory.jsHeapSizeLimit;

            let delay = 1;

            if (usedJSHeapSize > 0.75) {
                delay = 1000;
            }

            setTimeout(callback, delay);
        }

        pictos.forEach(picto => {
            picto.addEventListener('click', () => {
                const pictoSrc = picto.src;
                const pictoTitle = picto.title;

                savePicto(pictoSrc, pictoTitle, pictosDB);
            });
        });

        openDatabase();

        function zoekPictos() {
            const zoekInput = document.getElementById('search-bar').value.toLowerCase();
            const pictos = document.querySelectorAll('.all-pictos .picto');

            pictos.forEach(picto => {
                const title = picto.getAttribute('title').toLowerCase();
                const parentDiv = picto.parentElement;

                if (title.includes(zoekInput)) {
                    picto.style.display = 'inline-block';
                    if (parentDiv) {
                        const removeButton = parentDiv.querySelector('.remove-picto-button');
                        if (removeButton) {
                            removeButton.style.display = 'flex';
                        }
                    }
                } else {
                    picto.style.display = 'none';
                    if (parentDiv) {
                        const removeButton = parentDiv.querySelector('.remove-picto-button');
                        if (removeButton) {
                            removeButton.style.display = 'none';
                        }
                    }
                }
            });

            if (zoekInput === '') {
                pictos.forEach(picto => {
                    picto.style.display = 'inline-block';
                    const parentDiv = picto.parentElement;
                    if (parentDiv) {
                        const removeButton = parentDiv.querySelector('.remove-picto-button');
                        if (removeButton) {
                            removeButton.style.display = 'flex';
                        }
                    }
                });

                const allElements = document.querySelectorAll('.all-pictos > *');
                allElements.forEach(element => {
                    if (!element.classList.contains('picto')) {
                        element.style.display = 'block';
                    }
                });
            } else {
                const allElements = document.querySelectorAll('.all-pictos > *');
                allElements.forEach(element => {
                    if (!element.classList.contains('picto') && !element.id.includes('uploaded-pictos')) {
                        element.style.display = 'none';
                    }
                });
            }
        }

        document.getElementById('search-bar').addEventListener('input', zoekPictos);

        function savePictosAsPreset() {
            const transaction = db.transaction([pictosDB], 'readonly');
            const objectStore = transaction.objectStore(pictosDB);

            const request = objectStore.getAll();
            request.onsuccess = (event) => {
                const pictosArray = event.target.result;

                if (pictosArray.length > 0) {
                    const title = prompt("Geef een titel voor deze picto-preset (laat leeg om alleen de 1e picto weer te geven):");
                    if (title.length >= 30) {
                        notification("De titel moet minder dan 30 tekens zijn.");
                        return;
                    }

                    const presetsTransaction = db.transaction([pictoPresetsDB], 'readwrite');
                    const presetsStore = presetsTransaction.objectStore(pictoPresetsDB);

                    const pictoPreset = {
                        id: Date.now(),
                        title: title,
                        pictos: pictosArray.map(picto => ({
                            src: picto.src,
                            title: picto.title,
                        }))
                    };

                    const addRequest = presetsStore.add(pictoPreset);
                    addRequest.onsuccess = () => {
                        notification('Alle picto\'s zijn opgeslagen als één preset met de titel: ' + title);
                        console.log('Picto\'s geëxporteerd naar pictoPresetsDB:', pictoPreset);

                        loadFirstPictosInPresetSelecter();
                    };

                    addRequest.onerror = (event) => {
                        notification('Fout bij exporteren naar pictoPresetsDB: ' + event.target.error);
                        console.error('Fout bij exporteren naar pictoPresetsDB:', event.target.error);
                    };
                } else {
                    notification('Geen picto\'s gevonden in pictosDB om op te slaan.');
                }
            };

            request.onerror = (event) => {
                notification('Fout bij ophalen van picto\'s uit pictosDB: ' + event.target.error);
                console.error('Fout bij ophalen van picto\'s uit pictosDB:', event.target.error);
            };
        }

        function loadFirstPictosInPresetSelecter() {
            const transaction = db.transaction([pictoPresetsDB], 'readonly');
            const objectStore = transaction.objectStore(pictoPresetsDB);

            const request = objectStore.getAll();
            request.onsuccess = (event) => {
                const presetsArray = event.target.result;
                const presetSelecter = document.getElementById('preset-selecter');

                presetSelecter.innerHTML = "";

                presetsArray.forEach((preset, index) => {
                    if (preset.pictos.length > 0) {
                        const pictoContainer = document.createElement('div');
                        pictoContainer.style.position = 'relative';
                        pictoContainer.style.display = 'inline-block';

                        const firstPicto = preset.pictos[0];
                        const pictoElement = document.createElement("img");
                        pictoElement.src = firstPicto.src;
                        pictoElement.alt = firstPicto.title;
                        pictoElement.classList = 'picto';
                        pictoElement.dataset.presetIndex = index;

                        const titleElement = document.createElement('div');
                        titleElement.textContent = preset.title;
                        titleElement.style.color = 'white';
                        titleElement.style.fontWeight = 'bold';
                        titleElement.style.overflow = 'hidden';
                        titleElement.style.maxWidth = '100px';
                        titleElement.style.marginLeft = '10px';
                        titleElement.style.whiteSpace = 'nowrap';
                        titleElement.style.textOverflow = 'ellipsis';
                        titleElement.style.webkitLineClamp = '1';
                        titleElement.style.fontSize = '0.9em'

                        presetSelecter.appendChild(pictoElement);

                        const removeButton = document.createElement('img');
                        removeButton.src = '/assets/close-button.png';
                        removeButton.className = 'remove-picto-button';
                        removeButton.style.position = 'absolute';
                        removeButton.style.top = '3px';
                        removeButton.style.right = '7px';
                        removeButton.style.color = 'black';
                        removeButton.style.backgroundColor = 'red';
                        removeButton.style.border = '1px var(--text-color) solid';
                        removeButton.style.cursor = 'pointer';
                        removeButton.style.borderRadius = '50%';
                        removeButton.style.width = '30px';
                        removeButton.style.height = '30px';
                        removeButton.style.display = 'flex';
                        removeButton.style.alignItems = 'center';
                        removeButton.style.justifyContent = 'center';
                        removeButton.style.zIndex = '1';

                        pictoElement.addEventListener('click', () => {
                            loadPresetToDatabase(preset);
                        });

                        titleElement.addEventListener('click', () => {
                            loadPresetToDatabase(preset);
                        });

                        removeButton.addEventListener('click', () => {
                            removePresetFromDatabase(index);
                        });

                        pictoContainer.appendChild(pictoElement);
                        pictoContainer.appendChild(removeButton);
                        pictoContainer.appendChild(titleElement);
                        presetSelecter.appendChild(pictoContainer);
                    }
                });
            };
        }

        function removePresetFromDatabase(index) {
            const confirmDelete = confirm("Weet je zeker dat je de preset wil verwijderen? Deze actie kan niet ongedaan worden gemaakt.");
            if (!confirmDelete) {
                return;
            }

            const transaction = db.transaction([pictoPresetsDB], 'readwrite');
            const objectStore = transaction.objectStore(pictoPresetsDB);

            const request = objectStore.getAll();
            request.onsuccess = (event) => {
                const presetsArray = event.target.result;

                if (presetsArray[index]) {
                    const presetToDelete = presetsArray[index];

                    const deleteRequest = objectStore.delete(presetToDelete.id);
                    deleteRequest.onsuccess = () => {
                        console.log(`Preset met index ${index} is verwijderd.`);
                        loadFirstPictosInPresetSelecter();
                    };

                    deleteRequest.onerror = () => {
                        console.error('Er is een fout opgetreden bij het verwijderen van de preset.');
                    };
                } else {
                    console.error('Geen preset gevonden op deze index.');
                }
            };
        }

        function loadPresetToDatabase(preset) {
            const userConfirmed = confirm('Weet je het zeker dat je de preset wil laden? Je huidige planner zal worden verwijderd.');

            if (!userConfirmed) {
                return;
            }

            const transaction = db.transaction(['pictos'], 'readwrite');
            const objectStore = transaction.objectStore('pictos');
            document.getElementById('planner-content').innerHTML = '';

            const clearRequest = objectStore.clear();
            clearRequest.onsuccess = () => {
                preset.pictos.forEach((picto, index) => {
                    const newPicto = { ...picto, id: Date.now() + index };
                    const addRequest = objectStore.add(newPicto);

                    addRequest.onsuccess = () => {
                        console.log('Picto toegevoegd:', newPicto);
                    };

                    addRequest.onerror = (event) => {
                        console.error('Fout bij toevoegen van picto:', event.target.error);
                    };
                });

                notification('Preset succesvol geladen met nieuwe pictos.');
                loadPictos();
            };

            clearRequest.onerror = (event) => {
                notification('Fout bij wissen van pictos: ' + event.target.error);
                console.error('Fout bij wissen van pictos uit database:', event.target.error);
            };
        }

        /* PICTO PLANNER SETUP SCRIPT */
        function loadPlanner() {
            document.getElementById('planner-container').classList.add('visible');
            getSetting('pictoPlannerPin').then(pin => {
                if (!pin) {
                    editPlanner();
                }
            });
        }

        function editPlanner() {
            getSetting('pictoPlannerPin').then(storedPin => {
                if (storedPin) {
                    const pin = prompt("Voer je pincode in:");
                    if (pin === storedPin) {
                        document.getElementById('edit-button').style.display = 'none';
                        document.getElementById('edit-pictos').style.display = 'block';
                        document.getElementById('done-editing-button').style.display = 'block';
                    } else {
                        notification("Ongeldige pincode. Probeer het opnieuw.");
                    }
                } else {
                    document.getElementById('edit-button').style.display = 'none';
                    document.getElementById('edit-pictos').style.display = 'block';
                    document.getElementById('done-editing-button').style.display = 'block';
                }

                const editButton = document.getElementById('edit-button');
                const leftSide = document.getElementById('left-side');

                if (editButton.style.display === 'none') {
                    leftSide.classList.add('editing');
                } else {
                    leftSide.classList.remove('editing');
                }
            });
        }

        function doneEditingPlanner() {
            document.getElementById('edit-button').style.display = 'block';
            document.getElementById('edit-pictos').style.display = 'none';
            document.getElementById('done-editing-button').style.display = 'none';

            const editButton = document.getElementById('edit-button');
            const leftSide = document.getElementById('left-side');

            if (editButton.style.display === 'none') {
                leftSide.classList.add('editing');
            } else {
                leftSide.classList.remove('editing');
            }
        }

        function toggleSettings() {
            const settingsMenu = document.getElementById('settings-menu');
            const isMenuOpen = settingsMenu.style.display === 'block';

            if (isMenuOpen) {
                settingsMenu.style.display = 'none';
                document.getElementById('settings-button').style.display = "block";
                document.getElementById('done-editing-button').click();

                getSetting('pictoPlannerPin').then(pin => {
                    if (pin) {
                        document.getElementById('edit-button').style.display = 'block';
                    }
                });
            } else {
                getSetting('pictoPlannerPin').then(storedPin => {
                    if (storedPin) {
                        const pin = prompt("Voer je pincode in:");
                        if (pin === storedPin) {
                            settingsMenu.style.display = 'block';
                            document.getElementById('done-editing-button').click();
                            document.getElementById('settings-button').style.display = "none";
                            document.getElementById('edit-button').style.display = "none";
                        } else {
                            notification("Ongeldige pincode. Probeer het opnieuw.");
                        }
                    } else {
                        settingsMenu.style.display = 'block';
                        document.getElementById('done-editing-button').click();
                        document.getElementById('settings-button').style.display = "none";
                        document.getElementById('edit-button').style.display = "none";
                    }
                });
            }
        }

        checkSettings();
        function checkSettings() {
            getSetting('plannerSetupComplete').then(setupComplete => {
                if (!setupComplete) {
                    showSetupMenu();
                } else {
                    loadPlanner();
                }
            });
        }

        function showSetupMenu() {
            const setupMenu = document.getElementById('setup-menu');
            setupMenu.style.display = 'block';
        }

        function hideSetupMenu() {
            const setupMenu = document.getElementById('setup-menu');
            setupMenu.style.display = 'none';
        }

        function setupCreatePin() {
            document.getElementById('pinOrNot').style.display = 'none';
            document.getElementById('pinSetup').style.display = 'block';
        }

        function pincode(action, phase, pincode) {
            if (action === 'set') {
                if (phase === 'settings') {
                    if (pincode.length === 0) {
                        setSetting('pictoPlannerPin', '').then(() => {
                            notification("Je pincode is uitgeschakeld.");
                        });
                    } else {
                        if (pincode.length >= 3 && pincode.length <= 6) {
                            setSetting('pictoPlannerPin', pincode).then(() => {
                                notification("Je pincode is opgeslagen - " + pincode);
                            });
                        } else {
                            notification('De pincode moet tussen de 3 en 6 cijfers bevatten.');
                        }
                    }
                    return;
                }

                if (pincode.length >= 3 && pincode.length <= 6) {
                    setSetting('pictoPlannerPin', pincode).then(() => {
                        notification("Je pincode is opgeslagen - " + pincode);

                        if (phase === 'setup') {
                            setupCompleted();
                        }
                    });
                } else {
                    notification('De pincode moet tussen de 3 en 6 cijfers bevatten.');
                }
            }
        }

        function setupCompleted() {
            setSetting('plannerSetupComplete', true).then(() => {
                hideSetupMenu();
                loadPlanner();
            });
        }

        function setSetting(key, value) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(settingsDB, 'readwrite');
                const store = transaction.objectStore(settingsDB);
                const data = { id: key, value: value };

                const request = store.put(data);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getSetting(key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(settingsDB, 'readonly');
                const store = transaction.objectStore(settingsDB);

                const request = store.get(key);
                request.onsuccess = (event) => {
                    const result = event.target.result;
                    resolve(result ? result.value : null);
                };
                request.onerror = () => reject(request.error);
            });
        }
    </script>
</body>

</html>