<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Microfoon Luisteren</title>
    <link rel="stylesheet" href="/style.css">
    <script src="/script.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend&display=swap" rel="stylesheet">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            transition: background-color 0.3s;
        }
    </style>
</head>
<body>
    <button id="top-left-button" onclick="window.location.href='/';">Home</button>

    <h1 id="status">De microfoon luistert...</h1>

    <script>
        let noiseStart = 0;
        let lastAnnouncementTime = 0;
        const noiseThreshold = 150;
        const noiseDurationThreshold = 800;
        const announcementInterval = 3000; // 5 seconds

        // Vraag toestemming om de microfoon te gebruiken
        navigator.mediaDevices.getUserMedia({ audio: true })
        .then(function(stream) {
            const audioContext = new AudioContext();
            const analyser = audioContext.createAnalyser();
            const microphone = audioContext.createMediaStreamSource(stream);
            const javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);

            analyser.smoothingTimeConstant = 0.8;
            analyser.fftSize = 1024;

            microphone.connect(analyser);
            analyser.connect(javascriptNode);
            javascriptNode.connect(audioContext.destination);

            const statusElement = document.getElementById('status');

            javascriptNode.onaudioprocess = function() {
                const array = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(array);
                let maxVal = Math.max(...array);

                // Verminder de gevoeligheid met 50%
                maxVal = maxVal / 1.5;

                const redValue = Math.min(255, maxVal); // Max value for red channel
                const greenValue = 255 - redValue; // Adjust green channel inversely

                document.body.style.backgroundColor = `rgb(${redValue}, ${greenValue}, 0)`;

                const currentTime = new Date().getTime();
                if (maxVal > noiseThreshold) {
                    if (!noiseStart) {
                        noiseStart = currentTime;
                    } else if (currentTime - noiseStart > noiseDurationThreshold && currentTime - lastAnnouncementTime > announcementInterval) {
                        speak('Zachter Praten');
                        noiseStart = 0;
                        lastAnnouncementTime = currentTime;
                    }
                } else {
                    noiseStart = 0;
                    statusElement.innerText = 'De microfoon luistert...';
                }
            };
        })
        .catch(function(err) {
            console.log('De gebruiker heeft geen toestemming gegeven voor de microfoon of er is een andere fout opgetreden: ' + err);
        });

        function speak(text) {
            const msg = new SpeechSynthesisUtterance();
            msg.text = text;
            window.speechSynthesis.speak(msg);
        }
    </script>

</body>
</html>