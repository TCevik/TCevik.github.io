<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <title>Tamer zijn schoolrooster</title>
    <link rel="stylesheet" href="/style.css">
    <script src="/script.js"></script>
    <style>
        p {
            line-height: 1.6;
            margin: 8px 0;
        }

        #week-navigation {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>Tamer zijn schoolrooster</h1>
    <div id="week-navigation">
        <button onclick="changeWeek(-1)">‚¨ÖÔ∏è Vorige week</button>
        <button onclick="changeWeek(1)">Volgende week ‚û°Ô∏è</button>
    </div>
    <p>Hier kan je Tamer zijn schoolrooster zien.</p>
    <div id="output">De afspraken komen hier...</div>

    <script>
        let currentDate = new Date();
        if (currentDate.getDay() === 6 || currentDate.getDay() === 0) {
            currentDate.setDate(currentDate.getDate() + 7);
        }

        function getISOWeek(date) {
            const target = new Date(date.valueOf());
            const dayNr = (date.getDay() + 6) % 7;
            target.setDate(target.getDate() - dayNr + 3);
            const firstThursday = new Date(target.getFullYear(), 0, 4);
            const diff = (target - firstThursday) / 86400000;
            return 1 + Math.floor(diff / 7);
        }

        function changeWeek(offset) {
            currentDate.setDate(currentDate.getDate() + offset * 7);
            startParser();
        }

        function parseICalDate(value) {
            let formattedDateStr;
            if (/^\d{8}T\d{6}Z?$/.test(value)) {
                const year = value.substr(0, 4);
                const month = value.substr(4, 2);
                const day = value.substr(6, 2);
                const hour = value.substr(9, 2);
                const minute = value.substr(11, 2);
                const second = value.substr(13, 2);
                formattedDateStr = value.endsWith("Z")
                    ? `${year}-${month}-${day}T${hour}:${minute}:${second}Z`
                    : `${year}-${month}-${day}T${hour}:${minute}:${second}`;
                return new Date(formattedDateStr);
            }
            return new Date(value);
        }

        function parseICal(icalData) {
            const lines = icalData.split(/\r?\n/);
            const events = [];
            let currentEvent = null;

            lines.forEach(line => {
                if (line === "BEGIN:VEVENT") {
                    currentEvent = {};
                } else if (line === "END:VEVENT") {
                    if (currentEvent) {
                        events.push(currentEvent);
                        currentEvent = null;
                    }
                } else if (currentEvent !== null) {
                    const separatorIndex = line.indexOf(':');
                    if (separatorIndex !== -1) {
                        const keyWithParams = line.substring(0, separatorIndex);
                        const value = line.substring(separatorIndex + 1);
                        if (keyWithParams.startsWith("SUMMARY")) {
                            currentEvent.summary = value;
                        } else if (keyWithParams.startsWith("DTSTART")) {
                            currentEvent.start = parseICalDate(value);
                        } else if (keyWithParams.startsWith("DTEND")) {
                            currentEvent.end = parseICalDate(value);
                        }
                    }
                }
            });
            return events;
        }

        async function startParser() {
            try {
                const icalUrl = "https://api.somtoday.nl/rest/v1/icalendar/stream/84b872b2-462d-4f29-b924-f81cdf98c4ca/5d2f5a2f-0a12-43b8-a21a-66b42c392a20";
                const weekNumber = getISOWeek(currentDate);

                const response = await fetch(icalUrl);
                if (!response.ok) {
                    alert("Er is iets misgegaan bij het ophalen van de iCal data.");
                    return;
                }
                const icalText = await response.text();

                const events = parseICal(icalText);
                const filteredEvents = events.filter(event => event.start && getISOWeek(event.start) === weekNumber);

                filteredEvents.sort((a, b) => a.start - b.start);

                const groupedEvents = {};
                filteredEvents.forEach(event => {
                    const dayKey = event.start.toLocaleDateString("nl-NL", { weekday: 'long', day: 'numeric', month: 'long' });
                    if (!groupedEvents[dayKey]) {
                        groupedEvents[dayKey] = [];
                    }
                    groupedEvents[dayKey].push(event);
                });

                const outputDiv = document.getElementById("output");
                outputDiv.innerHTML = "";

                const days = Object.keys(groupedEvents).sort((a, b) => new Date(a.split("-").reverse().join("-")) - new Date(b.split("-").reverse().join("-")));
                if (days.length === 0) {
                    outputDiv.innerHTML = `<p>Geen afspraken gevonden voor week ${weekNumber}</p>`;
                } else {
                    days.forEach(day => {
                        const dayElement = document.createElement("p");
                        dayElement.innerHTML = `<br>üìÖ <strong>${day}</strong>`;

                        groupedEvents[day].sort((a, b) => a.start - b.start);
                        groupedEvents[day].forEach(event => {
                            const startTime = event.start.toLocaleTimeString("nl-NL", { hour: "2-digit", minute: "2-digit" });
                            let timeStr = `üïí ${startTime}`;
                            if (event.end) {
                                const endTime = event.end.toLocaleTimeString("nl-NL", { hour: "2-digit", minute: "2-digit" });
                                timeStr += ` - ${endTime}`;
                            }
                            dayElement.innerHTML += `<br> ${timeStr} - ‚úèÔ∏è ${event.summary || "Geen titel"}`;
                        });

                        outputDiv.appendChild(dayElement);
                    });
                }
            } catch (error) {
                console.error(error);
                alert("Er is een fout opgetreden: " + error.message);
            }
        }

        window.onload = startParser;
    </script>
</body>

</html>