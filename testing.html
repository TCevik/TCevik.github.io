<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>WebRTC Chat</title>
    <meta name='viewport' content='width=device-width, initializeial-scale=1'>
    <link rel="stylesheet" href="/style.css">
    <script src="/script.js"></script>
</head>

<body>
    <div id="add-person">
        <p><strong>Step 1:</strong> User 1, click "Create offer" to generate SDP offer and copy offer from text area
            below.
        </p>
        <button id="create-offer">Create Offer</button>

        <label>SDP OFFER:</label>
        <textarea id="offer-sdp" placeholder='User 2, paste SDP offer here...'></textarea>

        <p><strong>Step 2:</strong> User 2, paste SDP offer generated by user 1 into text area above, then click "Create
            Answer" to generate SDP answer and copy the answer from the text area below.</p>
        <button id="create-answer">Create Answer</button>

        <label>SDP Answer:</label>
        <textarea id="answer-sdp" placeholder="User 1, paste SDP answer here..."></textarea>

        <p><strong>Step 3:</strong> User 1, paste SDP offer generated by user 2 into text area above and then click "Add
            Answer".</p>
        <button id="add-answer">Add Answer</button>
    </div>

    <div id="chat" style="display: none;">
        <h2>Chat</h2>
        <div id="messages"></div>
        <div id="input-container">
            <input style="width: 50%;" type="text" id="message-input" placeholder="Type a message..." maxlength="1024"
                autocomplete="off">
            <button style="width: 20%;" id="send-message">Verzend</button>
        </div>
    </div>

</body>

<script>
    let peerConnection = new RTCPeerConnection();
    let dataChannel;
    let initialize = async () => {
        dataChannel = peerConnection.createDataChannel('chat');

        peerConnection.ondatachannel = (event) => {
            const receiveChannel = event.channel;
            receiveChannel.onmessage = (event) => {
                let messageDiv = document.createElement('div');
                messageDiv.textContent = event.data;
                document.getElementById('messages').appendChild(messageDiv);
            };
        };

        // Show chat and hide the input fields once the connection is established
        peerConnection.onconnectionstatechange = () => {
            if (peerConnection.connectionState === 'connected') {
                showChat(); // Show chat when connection is established
            }
        };
    };

    function showChat() {
        document.getElementById('add-person').style.display = 'none'; // Hide the SDP offer/answer section
        document.getElementById('chat').style.display = 'block'; // Show the chat section
    }

    let createOffer = async () => {
        peerConnection.onicecandidate = async (event) => {
            if (event.candidate) {
                const offerSDP = JSON.stringify(peerConnection.localDescription);
                try {
                    await navigator.clipboard.writeText(offerSDP);
                    notification('Offer SDP copied to clipboard!');
                } catch (err) {
                    notification('Failed to copy offer SDP to clipboard: ' + err);
                }
            }
        };

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
    };

    let createAnswer = async () => {
        let offer = JSON.parse(document.getElementById('offer-sdp').value);

        peerConnection.onicecandidate = async (event) => {
            if (event.candidate) {
                const answerSDP = JSON.stringify(peerConnection.localDescription);
                try {
                    await navigator.clipboard.writeText(answerSDP);
                    notification('Answer SDP copied to clipboard!');
                } catch (err) {
                    notification('Failed to copy answer SDP to clipboard: ' + err);
                }
            }
        };

        await peerConnection.setRemoteDescription(offer);

        let answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
    };

    let addAnswer = async () => {
        let answer = JSON.parse(document.getElementById('answer-sdp').value);
        if (!peerConnection.currentRemoteDescription) {
            peerConnection.setRemoteDescription(answer);
            notification('Person succesfully added!')
        }
    };

    let userName = 'User';

    let randomId = generateRandomNumbers();

    function generateRandomNumbers() {
        return Math.floor(Math.random() * 9000) + 1000;
    }

    let sendMessage = () => {
        let message = document.getElementById('message-input').value;
        if (dataChannel && message) {
            let messageWithName = `${userName}${randomId}: ${message}`;

            dataChannel.send(messageWithName);
            let messageDiv = document.createElement('div');
            messageDiv.textContent = messageWithName;
            document.getElementById('messages').appendChild(messageDiv);
            document.getElementById('message-input').value = '';
            document.getElementById("message-input").focus();
        }
    };

    initialize();

    document.getElementById('create-offer').addEventListener('click', createOffer);
    document.getElementById('create-answer').addEventListener('click', createAnswer);
    document.getElementById('add-answer').addEventListener('click', addAnswer);
    document.getElementById('send-message').addEventListener('click', sendMessage);
</script>

</html>