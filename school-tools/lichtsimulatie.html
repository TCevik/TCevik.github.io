<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TC_tam Lichtsimulatie</title>
    <link rel="stylesheet" href="/style.css">
    <script src="/script.js"></script>

    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            height: 100vh;
            overflow-y: hidden;
        }

        canvas {
            border: 1px solid black;
            background-color: white;
        }
    </style>
</head>

<body>
    <canvas id="dotsCanvas" width="600" height="600"></canvas>
    <div style="margin-left: 20px;">
        <p>Klik op 2 stippen om daar tussen lijnen te maken.</p>
        <button id="undoButton">Undo</button>

        <select id="typeLine">
            <option value="spiegel">Spiegel</option>
            <option value="laser">Laser</option>
        </select>
    </div>
    <script>
        // Haal de <select> en de waarde op
        const selectElement = document.getElementById("typeLine");
        let typeLine = selectElement.value;  // Zet de waarde van de geselecteerde optie
        selectElement.addEventListener("change", (event) => {
            typeLine = event.target.value;  // Update de waarde van typeLine
            notification('Je maakt nu een ' + typeLine + '.');  // Laat de nieuwe waarde zien in de console
        });

        // Selecteer het canvas en verkrijg de 2D-context
        const canvas = document.getElementById("dotsCanvas");
        const ctx = canvas.getContext("2d");
        const undoButton = document.getElementById("undoButton");

        // Configuratie van het raster
        const gridSize = 30; // Aantal stippen in het raster (een vierkant)
        const dotRadius = 5; // Straal van elke stip
        const margin = 10; // Ruimte langs de randen

        // Arrays voor stippenlocaties, geselecteerde stippen en lijnen
        const dots = [];
        const selectedDots = [];
        const lines = []; // Opslag voor getekende lijnen

        // Bereken de spacing op basis van het aantal stippen en de beschikbare ruimte
        const spacing = (canvas.width - 2 * margin) / (gridSize - 1);

        function drawGrid() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (const dot of dots) {
                ctx.beginPath();
                ctx.arc(dot.x, dot.y, dotRadius, 0, Math.PI * 2);
                ctx.fillStyle = "#bfbfbf";
                ctx.fill();
                ctx.closePath();
            }

            for (const line of lines) {
                ctx.beginPath();
                ctx.moveTo(line.start.x, line.start.y);
                ctx.lineTo(line.end.x, line.end.y);
                ctx.strokeStyle = line.color || "#000";
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.closePath();
            }

            for (const dot of selectedDots) {
                ctx.beginPath();
                ctx.arc(dot.x, dot.y, dotRadius, 0, Math.PI * 2);
                ctx.fillStyle = "#000";
                ctx.fill();
                ctx.closePath();
            }
        }

        // Initializeer de stippen in het raster
        for (let i = 0; i < gridSize; i++) {
            for (let j = 0; j < gridSize; j++) {
                const x = margin + i * spacing;
                const y = margin + j * spacing;
                dots.push({ x, y });
            }
        }

        // Teken het initiÃ«le raster
        drawGrid();

        canvas.addEventListener("click", (event) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = event.clientX - rect.left;
            const mouseY = event.clientY - rect.top;

            // Vind de dichtstbijzijnde stip
            const clickedDot = dots.find(dot => {
                const dx = dot.x - mouseX;
                const dy = dot.y - mouseY;
                return Math.sqrt(dx * dx + dy * dy) <= dotRadius * 2.5;
            });

            if (clickedDot) {
                const alreadySelected = selectedDots.some(dot => dot.x === clickedDot.x && dot.y === clickedDot.y);

                if (!alreadySelected) {
                    selectedDots.push(clickedDot);

                    if (selectedDots.length === 2) {
                        const [dot1, dot2] = selectedDots;

                        if (typeLine === "spiegel") {
                            lines.push({ start: dot1, end: dot2 });
                        } else if (typeLine === "laser") {
                            // Bereken richting
                            const dx = dot2.x - dot1.x;
                            const dy = dot2.y - dot1.y;
                            const length = Math.sqrt(dx * dx + dy * dy);
                            const unitX = dx / length;
                            const unitY = dy / length;

                            // Start en check voor obstakels
                            let currentX = dot1.x;
                            let currentY = dot1.y;
                            let laserHit = false;

                            // Stap door de laserstraal totdat het canvas eindigt of een obstakel geraakt wordt
                            while (!laserHit &&
                                currentX >= 0 && currentX <= canvas.width &&
                                currentY >= 0 && currentY <= canvas.height) {
                                // Controleer of een spiegel geraakt wordt
                                for (const line of lines) {
                                    if (line.color !== "red" && isPointOnLine({ x: currentX, y: currentY }, line)) {
                                        laserHit = true;
                                        break;
                                    }
                                }

                                if (!laserHit) {
                                    currentX += unitX;
                                    currentY += unitY;
                                }
                            }

                            // Voeg de laserlijn toe, tot aan het obstakel of de rand
                            lines.push({
                                start: dot1,
                                end: laserHit ? { x: currentX, y: currentY } : { x: currentX, y: currentY },
                                color: "red"
                            });
                        }

                        selectedDots.length = 0;
                    }

                    drawGrid();
                }
            }
        });

        function isPointOnLine(point, line) {
            const tolerance = 1; // Hoe precies we willen zijn
            const { x, y } = point;
            const { start, end } = line;

            const crossProduct = Math.abs((y - start.y) * (end.x - start.x) - (x - start.x) * (end.y - start.y));
            const distance = Math.sqrt((end.x - start.x) ** 2 + (end.y - start.y) ** 2);

            // Controleer of het punt op de lijn ligt (binnen de tolerantie)
            return crossProduct / distance < tolerance &&
                x >= Math.min(start.x, end.x) && x <= Math.max(start.x, end.x) &&
                y >= Math.min(start.y, end.y) && y <= Math.max(start.y, end.y);
        }

        // Eventlistener voor de Undo-knop
        undoButton.addEventListener("click", () => {
            if (lines.length > 0) {
                lines.pop(); // Verwijder de laatste lijn
                drawGrid(); // Herteken het raster
            }
        });

        // Eventlistener voor Ctrl+Z
        document.addEventListener("keydown", (event) => {
            if (event.ctrlKey && event.key === 'z') {
                if (lines.length > 0) {
                    lines.pop(); // Verwijder de laatste lijn
                    drawGrid(); // Herteken het raster
                }
            }
        });
    </script>
</body>

</html>