<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>WebRTC</title>
</head>

<body>
    <div id="setup-container">
        <button id="create-offer">Create Offer</button>
        <button id="create-answer">Create Answer</button>
        <button id="add-answer">Add Answer</button>
        <button id="fast-setup">Fast Setup</button>
    </div>

    <div id="fast-setup-container" style="display: none;">
        <div id="user-nr-select">
            <p>What user do you want to be? (this will not make a difference when using the app)</p>
            <button id="user-1-btn">User 1</button>
            <button id="user-2-btn">User 2</button>
        </div>

        <div id="qr-shower" style="display: none; width: 100%; height: 100%;">
            <canvas style="border: 1px solid black;" id="qrCodeContainer"></canvas>
        </div>

        <div id="qr-scanner" style="display: none;">
            <p>Scan the QR code that the other user has on the screen.</p>
            <div id="reader"></div>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

    <script>
        let peerConnection = new RTCPeerConnection()
        let offerSDP
        let answerSDP

        let init = () => {
            peerConnection.createDataChannel('dataChannel');

            peerConnection.onconnectionstatechange = () => {
                if (peerConnection.connectionState === 'connected') {
                    alert('Connection established!');
                }
            };
        }

        let createOffer = async () => {
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            peerConnection.onicecandidate = async (event) => {
                if (event.candidate === null) {
                    offerSDP = JSON.stringify(peerConnection.localDescription);
                    await navigator.clipboard.writeText(offerSDP);
                    peerConnection.onicecandidate = null;
                }
            };
        }

        let createAnswer = async (offer) => {
            await peerConnection.setRemoteDescription(offer);

            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            peerConnection.onicecandidate = async (event) => {
                if (event.candidate === null) {
                    answerSDP = JSON.stringify(peerConnection.localDescription);
                    await navigator.clipboard.writeText(answerSDP);
                    peerConnection.onicecandidate = null;
                }
            };
        }

        let addAnswer = async (answer) => {
            if (!peerConnection.currentRemoteDescription) {
                peerConnection.setRemoteDescription(answer);
            }
        }

        init()

        document.getElementById('create-offer').addEventListener('click', createOfferBtnClick);
        document.getElementById('create-answer').addEventListener('click', takeOffer);
        document.getElementById('add-answer').addEventListener('click', takeAnswer);
        document.getElementById('fast-setup').addEventListener('click', fastSetup);

        function createOfferBtnClick() {
            alert('Offer SDP copied to clipboard!');
            createOffer();
        }

        function takeOffer() {
            let offer = JSON.parse(prompt('Paste the offer SDP here:'));
            alert('Answer SDP copied to clipboard!');
            createAnswer(offer);
        }

        function takeAnswer() {
            let answer = JSON.parse(prompt('Paste the answer SDP here:'));
            addAnswer(answer);
        }

        function fastSetup() {
            document.getElementById('setup-container').style.display = "none";
            document.getElementById('fast-setup-container').style.display = "block";

            document.getElementById('user-1-btn').addEventListener('click', function () {
                document.getElementById('user-nr-select').style.display = 'none';
                document.getElementById('qr-shower').style.display = 'block';
                createOffer();
                setTimeout(() => {
                    generateQRCode(offerSDP);
                }, 500);
            });

            document.getElementById('user-2-btn').addEventListener('click', function () {
                document.getElementById('user-nr-select').style.display = 'none';
                document.getElementById('qr-scanner').style.display = 'block';
                startScanner();
            });
        }

        function startScanner() {
            const html5QrCode = new Html5Qrcode("reader");

            const config = { fps: 10 };

            navigator.mediaDevices.enumerateDevices().then(devices => {
                const videoDevices = devices.filter(device => device.kind === 'videoinput');

                if (videoDevices.length > 0) {
                    const deviceId = videoDevices[1].deviceId;

                    html5QrCode.start(
                        { deviceId: { exact: deviceId } }, 
                        config,
                        (decodedText, decodedResult) => {
                            createAnswer(decodedText);
                            html5QrCode.stop().then(() => {
                                console.log("Scanner gestopt");
                            }).catch(err => {
                                console.error("Fout bij stoppen van de scanner: ", err);
                            });
                        },
                        (errorMessage) => {
                            console.log("Scanning... " + errorMessage);
                        }
                    ).catch(err => {
                        console.error("Fout bij starten van de scanner: ", err);
                    });
                } else {
                    alert("Geen camera gevonden.");
                }
            }).catch(err => {
                console.error("Fout bij het ophalen van camera-apparaten: ", err);
            });
        }

        function generateQRCode(text) {
            QRCode.toCanvas(document.getElementById('qrCodeContainer'), offerSDP, { width: 800, errorCorrectionLevel: 'L' }, function (error) {
                if (error) console.error(error);
                console.log('QR code generated');
            });
        }
    </script>
</body>

</html>