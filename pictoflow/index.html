<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PictoFlow</title>
</head>

<body>
    <div id="setupMenu">
        <div id="step1">
            <h1>Welcome!</h1>
            <h4>PictoFlow: Organize your day with clarity, simplicity, and fun.</h4>
            <button onclick="setupContinue(2)">Continue</button>
        </div>

        <div id="step2" style="display:none;">
            <h1>Would you like to set a PIN?</h1>
            <h4>You can also set it later if you prefer.</h4>
            <button onclick="setupNoPin()">No</button>
            <button onclick="setupContinue(3)">Yes</button>
        </div>

        <div id="step3" style="display:none;">
            <h1>Please enter your PIN</h1>
            <input type="number" id="pinInput" placeholder="Enter a 4 to 6 digit PIN" maxlength="6">
            <button onclick="savePinAndContinue()">Continue</button>
        </div>

        <div id="step4" style="display:none;">
            <h1>That's all! You're all set.</h1>
            <button onclick="setupDone()">Go to PictoFlow</button>
        </div>
    </div>

    <div id="main" style="display:none;">
        <script async
            src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8924607946192862"
            crossorigin="anonymous"></script>
        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8924607946192862"
            data-ad-slot="5862330293" data-ad-format="auto" data-full-width-responsive="true"></ins>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
        </script>

        <button id="toggleEditorBtn" onclick="toggleEditor()">Open Editor</button>
        <div id="planning" style="min-height:100px; border:1px solid black; padding:10px;">
            <h2>Planning</h2>
            <p>Drag images here to create or reorder your plan.</p>
        </div>

        <div id="editor" style="display:none; border:1px solid black; margin-top:10px; padding:10px;">
            <h2>Editor</h2>
            <div id="imageContainer">
                <img src="https://cdn-icons-png.flaticon.com/512/616/616408.png" draggable="true" alt="Breakfast"
                    width="80">
                <img src="https://cdn-icons-png.flaticon.com/512/616/616430.png" draggable="true" alt="School"
                    width="80">
                <img src="https://cdn-icons-png.flaticon.com/512/616/616487.png" draggable="true" alt="Lunch"
                    width="80">
                <img src="https://cdn-icons-png.flaticon.com/512/616/616510.png" draggable="true" alt="Homework"
                    width="80">
                <img src="https://cdn-icons-png.flaticon.com/512/616/616545.png" draggable="true" alt="Play" width="80">
                <img src="https://cdn-icons-png.flaticon.com/512/616/616491.png" draggable="true" alt="Sleep"
                    width="80">
            </div>
        </div>

        <script async
            src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8924607946192862"
            crossorigin="anonymous"></script>
        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8924607946192862"
            data-ad-slot="5862330293" data-ad-format="auto" data-full-width-responsive="true"></ins>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>

    <script>
        // ---------- Setup Menu ----------
        function setupContinue(step) {
            for (let i = 1; i <= 4; i++) {
                const stepDiv = document.getElementById("step" + i);
                if (stepDiv) stepDiv.style.display = "none";
            }
            const currentStep = document.getElementById("step" + step);
            if (currentStep) currentStep.style.display = "block";
        }

        function setupDone() {
            const transaction = db.transaction(["settings"], "readwrite");
            const store = transaction.objectStore("settings");
            store.put({ id: "setupComplete", value: true });

            transaction.oncomplete = function () {
                document.getElementById("setupMenu").style.display = "none";
                document.getElementById("main").style.display = "block";
                loadPlanning();
            };
        }

        let db;
        const request = indexedDB.open("PictoFlowDB", 2);

        request.onerror = function (event) {
            console.error("Database error:", event.target.error);
        };

        request.onupgradeneeded = function (event) {
            db = event.target.result;
            if (!db.objectStoreNames.contains("settings")) {
                db.createObjectStore("settings", { keyPath: "id" });
            }
            if (!db.objectStoreNames.contains("planning")) {
                db.createObjectStore("planning", { keyPath: "id" });
            }
        };

        request.onsuccess = function (event) {
            db = event.target.result;
            const transaction = db.transaction(["settings"], "readonly");
            const store = transaction.objectStore("settings");
            const getSetup = store.get("setupComplete");

            getSetup.onsuccess = function () {
                if (getSetup.result && getSetup.result.value === true) {
                    document.getElementById("setupMenu").style.display = "none";
                    document.getElementById("main").style.display = "block";
                    loadPlanning();
                }
            };
        };

        function savePinAndContinue() {
            const pinInput = document.getElementById("pinInput").value;
            if (!pinInput || pinInput.length < 4 || pinInput.length > 6) {
                alert("Please enter a valid 4 to 6 digit PIN.");
                return;
            }
            const transaction = db.transaction(["settings"], "readwrite");
            const store = transaction.objectStore("settings");
            store.put({ id: "userPin", pin: pinInput });
            transaction.oncomplete = function () {
                setupContinue(4);
            };
        }

        function setupNoPin() {
            const transaction = db.transaction(["settings"], "readwrite");
            const store = transaction.objectStore("settings");
            store.put({ id: "userPin", pin: null });
            transaction.oncomplete = function () {
                setupContinue(4);
            };
        }

        // ---------- Editor & Planning ----------
        const planning = document.getElementById("planning");
        const editor = document.getElementById("editor");
        let draggedItem = null;

        function toggleEditor() {
            const btn = document.getElementById("toggleEditorBtn");
            const isClosed = editor.style.display === "none";

            if (isClosed) {
                editor.style.display = "block";
                btn.textContent = "Close Editor";
                setImagesDraggable(true);
            } else {
                editor.style.display = "none";
                btn.textContent = "Open Editor";
                setImagesDraggable(false);
            }
        }

        function setImagesDraggable(enabled) {
            const allImages = document.querySelectorAll("#planning img, #imageContainer img");
            allImages.forEach(img => {
                img.draggable = enabled;
            });
        }

        // Alleen slepen als editor open is
        document.addEventListener("dragstart", function (e) {
            if (editor.style.display === "none") {
                e.preventDefault();
                return;
            }

            if (e.target.tagName === "IMG") {
                draggedItem = e.target;
                e.dataTransfer.setData("imageSrc", e.target.src);
            }
        });

        // Planning - drop
        planning.addEventListener("dragover", function (e) {
            e.preventDefault();
        });

        planning.addEventListener("drop", function (e) {
            e.preventDefault();
            if (editor.style.display === "none") return;

            const imageSrc = e.dataTransfer.getData("imageSrc");

            if (!draggedItem.parentElement || draggedItem.parentElement.id === "imageContainer") {
                // Nieuw plaatje uit editor
                const img = document.createElement("img");
                img.src = imageSrc;
                img.width = 80;
                img.draggable = true;
                img.addEventListener("dragstart", handlePlanningDragStart);
                img.addEventListener("dragend", handlePlanningDragEnd);
                planning.appendChild(img);
            } else {
                // Reorder bestaande
                const afterElement = getDragAfterElement(planning, e.clientX);
                if (afterElement == null) {
                    planning.appendChild(draggedItem);
                } else {
                    planning.insertBefore(draggedItem, afterElement);
                }
            }

            savePlanning();
        });

        // ---------- Nieuw: terug slepen naar editor verwijdert afbeelding ----------
        editor.addEventListener("dragover", function (e) {
            e.preventDefault();
        });

        editor.addEventListener("drop", function (e) {
            e.preventDefault();
            if (draggedItem && draggedItem.parentElement === planning) {
                draggedItem.remove(); // verwijder uit planning
                savePlanning();
                console.log("Afbeelding teruggesleept naar editor en verwijderd uit planning.");
            }
        });

        function handlePlanningDragStart(e) {
            draggedItem = e.target;
            e.target.classList.add("dragging");
        }

        function handlePlanningDragEnd(e) {
            e.target.classList.remove("dragging");
            savePlanning();
        }

        function getDragAfterElement(container, x) {
            const draggableElements = [...container.querySelectorAll("img:not(.dragging)")];
            return draggableElements.reduce(
                (closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = x - box.left - box.width / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                },
                { offset: Number.NEGATIVE_INFINITY }
            ).element;
        }

        planning.addEventListener("DOMNodeInserted", function (e) {
            if (e.target.tagName === "IMG") {
                e.target.addEventListener("dragstart", handlePlanningDragStart);
                e.target.addEventListener("dragend", handlePlanningDragEnd);
            }
        });

        // ---------- Opslaan & Laden ----------
        function savePlanning() {
            const images = [...planning.querySelectorAll("img")].map(img => img.src);
            const transaction = db.transaction(["planning"], "readwrite");
            const store = transaction.objectStore("planning");
            store.put({ id: "userPlanning", images: images });
            console.log("Planning saved:", images);
        }

        function loadPlanning() {
            const transaction = db.transaction(["planning"], "readonly");
            const store = transaction.objectStore("planning");
            const request = store.get("userPlanning");

            request.onsuccess = function () {
                if (request.result && request.result.images) {
                    request.result.images.forEach(src => {
                        const img = document.createElement("img");
                        img.src = src;
                        img.width = 80;
                        img.draggable = false;
                        img.addEventListener("dragstart", handlePlanningDragStart);
                        img.addEventListener("dragend", handlePlanningDragEnd);
                        planning.appendChild(img);
                    });
                    console.log("Planning loaded!");
                }
            };
        }
    </script>
</body>

</html>